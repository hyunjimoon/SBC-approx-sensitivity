---
title: "SelfConsistentPrior"
output: html_document
---

```{r setup, include=FALSE}
library(cmdstanr)
library(dplyr)
library(tidyverse)
library(reshape)
library(parallel)
library(posterior)
#library(rstanarm)
devtools::install_github("hyunjimoon/SBC",ref="workflow")
library(SBC)
library(pracma)
library("entropy")
set.seed(1954)
.libPaths("~/Rlib")
source("tools/selfCalib.R")
source("tools/functions.r")
options(mc.cores = parallel::detectCores())
set_get_Dir <- function(modelName){
  scriptDir <- getwd()
  modDir <- file.path(scriptDir, "models")
  dataDir <- file.path(scriptDir, "data")
  delivDir <- file.path(scriptDir, "deliv", modelName)
  dir.create(delivDir)
  file <- file.path(modDir, modelName, paste0(modelName, ".stan"))
  mod <- cmdstan_model(file)
  return(list(data = data, mod = mod, modDir = modDir, file = file, delivDir = delivDir)) 
}

```

# 1. normal model with mean parameter with distribution
```{R}
modelName = "simple_normal"
modDir <- set_get_Dir(modelName)$modDir
delivDir <- set_get_Dir(modelName)$delivDir
file <- set_get_Dir(modelName)$file
simple_normal = cmdstanr::cmdstan_model(file)
generator <- function(){  
    function(){
    theta <- rnorm(1, 0, 1)
    list(
      generated = rnorm(8, theta, 1),
      parameters = list(
        theta = theta
      )
    )
  }
}
par = "theta"
D <- 8
y <- rep(0, D) # placeholder
data = list("D"= D, "y"= y, "theta_loc"= 0, "theta_scale"= 1)
nChains <- 4
parallel_chains <- min(nChains, detectCores())
N = 1000
M = 10 # 40
workflow <- SBCWorkflow$new(simple_normal, generator())
workflow$simulate(N) 
workflow$fit_model(sample_iterations = M, warmup_iterations = M, data)
prior <- workflow$prior_samples
post <- workflow$posterior_samples
workflow$calculate_rank()
plot_ecdf_diff(workflow, var="theta")

#target calibration
par<-  "theta" #names(prior)[c(1)] 
evolve_df <- initDf(1, summary = "pars")
sc_prior <-  selfCalib(stan_model = simple_normal, prior, par, data, N, M, cnt = 1, evolve_df, delivDir, is_param = FALSE)

# test self-consistency for sc_prior
generator_np <- function(){
  function(theta){
    list(
      generated = rnorm(8, theta, 1),
      parameters = list(
        theta = theta
      )
    )
  }
}
sc_workflow <- SBCWorkflow$new(stan_model, generator_np())
sc_workflow$simulate(n_sbc_iterations = N, param = is_param, as_draws_df(sc_prior)[[pars]])
data$theta_loc = mean(sc_prior[[pars]])  
data$theta_scale = sd(sc_prior[[pars]])
sc_workflow$fit_model(sample_iterations = M, warmup_iterations = M, data)
sc_pri <- sc_workflow$prior_samples
sc_post <- sc_workflow$posterior_samples
sc_workflow$calculate_rank()
plot_ecdf_diff(sc_workflow, var="theta")
```
